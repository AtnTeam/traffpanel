<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loading...</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            overflow: hidden;
        }

        .loader-container {
            text-align: center;
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loader-text {
            font-size: 18px;
            font-weight: 500;
            opacity: 0.9;
        }

        #tracking-data {
            display: none;
        }
    </style>
</head>
<body>
    <div class="loader-container">
        <div class="loader"></div>
        <div class="loader-text">Processing your request...</div>
    </div>

    <div id="tracking-data" 
         data-referrer="{referrer}"
         data-offer="{offer}"
         data-api-url="{api_url}"></div>

    <script>
        (function() {
            const trackingData = document.getElementById('tracking-data');
            
            // Get domain from multiple sources
            function getDomain() {
                // 1. Try from Keitaro {referrer} variable
                const referrer = trackingData?.getAttribute('data-referrer') || '';
                if (referrer && referrer !== '{referrer}' && referrer !== '' && referrer !== '$') {
                    try {
                        // If it's already a domain (contains dot, no spaces, no protocol)
                        if (referrer.includes('.') && !referrer.includes(' ') && !referrer.includes('://')) {
                            return referrer.split('/')[0].split('?')[0].split(':')[0];
                        }
                        // If it's a full URL
                        const url = new URL(referrer.startsWith('http') ? referrer : 'https://' + referrer);
                        return url.hostname;
                    } catch (e) {
                        // Try to extract domain manually
                        const match = referrer.match(/(?:https?:\/\/)?([^\/\s\?]+)/);
                        if (match && match[1] && match[1].includes('.')) {
                            return match[1].split(':')[0];
                        }
                    }
                }
                
                // 2. Try from URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                let domain = urlParams.get('source') || urlParams.get('domain') || urlParams.get('referrer');
                
                // Clean domain from URL params
                if (domain) {
                    domain = domain.trim();
                    if (domain.includes('://')) {
                        try {
                            const url = new URL(domain);
                            domain = url.hostname;
                        } catch (e) {
                            domain = domain.split('/')[2] || domain.split('/')[0];
                        }
                    }
                    if (domain && domain.includes('.')) {
                        return domain.split('/')[0].split('?')[0].split(':')[0];
                    }
                }
                
                // 3. Try from document.referrer
                if (!domain && document.referrer) {
                    try {
                        const refUrl = new URL(document.referrer);
                        domain = refUrl.hostname;
                    } catch (e) {
                        // Ignore
                    }
                }
                
                return domain || null;
            }

            // Get API URL - must be absolute URL, always use HTTPS with domain
            function getApiUrl() {
                let apiUrl = trackingData?.getAttribute('data-api-url') || 
                            new URLSearchParams(window.location.search).get('api_url') || 
                            '';
                
                // Clean URL
                apiUrl = apiUrl.trim().replace(/\/$/, '');
                
                // If not absolute URL, use default HTTPS domain
                if (!apiUrl.startsWith('http://') && !apiUrl.startsWith('https://')) {
                    // Always use HTTPS with domain through Cloudflare
                    apiUrl = 'https://cetoki.com';
                } else {
                    // Always convert HTTP to HTTPS for security
                    if (apiUrl.startsWith('http://')) {
                        apiUrl = apiUrl.replace('http://', 'https://');
                    }
                    // Replace IP addresses with domain if present
                    if (apiUrl.includes('64.111.93.10')) {
                        apiUrl = apiUrl.replace(/64\.111\.93\.10(?::\d+)?/, 'cetoki.com');
                    }
                }
                
                return `${apiUrl}/api/keitaro/sub_id_2`;
            }

            // Flag to prevent multiple redirects
            let redirectExecuted = false;
            
            // Fixed base offer URL (we always redirect here)
            const BASE_OFFER_URL = 'https://lowkey-media.live/pwagroup';
            
            // Redirect with sub_id_2 (if no sub_id_2, use "null" as string)
            function redirect(sub_id_2) {
                // Prevent multiple redirects
                if (redirectExecuted) return;
                redirectExecuted = true;
            
                const sub2Value = sub_id_2 || 'null';
            
                try {
                    // Build URL from fixed offer
                    const url = new URL(BASE_OFFER_URL);
            
                    // Ensure no old params
                    url.searchParams.delete('sub2');
                    url.searchParams.delete('sub_id_2');
            
                    // Set params with value from API
                    url.searchParams.set('sub2', sub2Value);
                    url.searchParams.set('sub_id_2', sub2Value);
            
                    window.location.href = url.toString();
                } catch (e) {
                    // Fallback: construct URL manually if URL() fails
                    const encoded = encodeURIComponent(sub2Value);
                    window.location.href = `${BASE_OFFER_URL}?sub2=${encoded}&sub_id_2=${encoded}`;
                }
            }

            // Main process - ALWAYS makes API request
            async function process() {
                const domain = getDomain();
                const apiUrl = getApiUrl();
                
                // Build request URL - only include source if domain exists
                let requestUrl;
                if (domain && domain.trim() !== '') {
                    requestUrl = `${apiUrl}?source=${encodeURIComponent(domain)}`;
                } else {
                    // If no domain, still make request but without source parameter
                    requestUrl = apiUrl;
                }

                // Set up timeout for API request (5 seconds) - primary timeout
                const apiTimeout = setTimeout(() => {
                    if (!redirectExecuted) {
                        redirect(null);
                    }
                }, 5000);

                // Set up fallback timeout (5 seconds) - guarantees redirect even if everything fails
                // Same as apiTimeout to ensure maximum wait time is exactly 5 seconds
                const fallbackTimeout = setTimeout(() => {
                    if (!redirectExecuted) {
                        redirect(null);
                    }
                }, 5000);

                try {
                    // Create AbortController for fetch timeout
                    const controller = new AbortController();
                    const fetchTimeout = setTimeout(() => controller.abort(), 5000);

                    const response = await fetch(requestUrl, {
                        method: 'GET',
                        headers: { 
                            'Accept': 'application/json'
                        },
                        mode: 'cors',
                        cache: 'no-cache',
                        signal: controller.signal
                    });

                    clearTimeout(fetchTimeout);
                    clearTimeout(apiTimeout);

                    if (response.ok) {
                        const data = await response.json();
                        clearTimeout(fallbackTimeout);
                        redirect(data.sub_id_2 || null);
                    } else {
                        clearTimeout(fallbackTimeout);
                        redirect(null);
                    }
                } catch (e) {
                    // Don't clear apiTimeout here - let it handle the redirect
                    // If it's an abort error, apiTimeout will handle it
                    // For other errors, redirect immediately
                    if (e.name !== 'AbortError' && !redirectExecuted) {
                        clearTimeout(apiTimeout);
                        clearTimeout(fallbackTimeout);
                        redirect(null);
                    }
                    // For AbortError, apiTimeout will fire and handle redirect
                }
            }

            // Start immediately
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', process);
            } else {
                process();
            }
        })();
    </script>
</body>
</html>
